<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ê²°ì œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="../common.js"></script>
    <script src="admin_header.js"></script>

    <link href="../style.css" rel="stylesheet"> 
</head>
<body>
    <main id="admin_payment_main" class="admin_main">
        <h2>ê²°ì¬ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸</h2>

        <ul class="list">

        </ul>
    </main>

    <script>
        const CANCEL_REASON_LIST = [
            { label: 'ë‹¨ìˆœ ë³€ì‹¬', value: 'ë‹¨ìˆœ ë³€ì‹¬' },
            { label: 'ê³ ê°ì— ì˜í•œ ê´€ë¦¬ì ì·¨ì†Œ', value: 'ê³ ê°ì— ì˜í•œ ê´€ë¦¬ì ì·¨ì†Œ' }
        ];

        function renderPaymentList(list) {
            const PAYMENT_LIST_ELEMENT = $('#admin_payment_main .list');

            if (!list || list.length === 0) {
                PAYMENT_LIST_ELEMENT.html('<li>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>');
                return;
            }

            let html = '';

            list.forEach(item => {
                const isPaid = item.orderStatus && item.orderStatus.toUpperCase() === 'PAID';

                html += `
                    <li>
                        <p class="nickname">${item.nickname}</p>

                        <div class="order_data">
                            <p class="order_no">ì£¼ë¬¸ ë²ˆí˜¸: ${item.orderNo}</p>
                            <p class="payment_no">ê²°ì œ ë²ˆí˜¸: ${item.paymentKey}</p>
                        </div>

                        <div class="option_data">
                            <p class="option">${item.productOptionName}</p>
                            <p class="total_amount">${Number(item.totalAmount).toLocaleString()}</p>
                        </div>

                        ${
                            isPaid ? `
                            <div class="btn_box">
                                <button class="btn" type="button" data-order_id="${item.orderId}">
                                    ê²°ì œì·¨ì†Œ
                                </button>
                            </div>
                            ` : ''
                        }

                        <span class="status">${item.orderStatus}</span>
                    </li>
                `;
            });

            PAYMENT_LIST_ELEMENT.html(html);
        }

        function fetchPaymentList() {
            $.ajax({
                url: SPRING_BOOT_URL + "/zero9/admin/payments",
                method: "GET",
                dataType: "json",
                headers: {
                    Authorization: ACCESS_TOKEN
                },
                success: function(res){
                    renderPaymentList(res.data);
                },
                error: function(err){
                    console.error("ê²°ì œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                    alert("ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        fetchPaymentList();

        $(document).on("click", "#admin_payment_main .btn", function () {

            const orderId = String($(this).data('order_id'));

            popupLayer("admin_payment_list_popup", true);

            $("#admin_payment_list_popup").data('order_id', orderId);

            const html = `
                <p class="title">ê²°ì œ ì·¨ì†Œ ì´ìœ </p>
                <select id="payment_cancel_select">
                    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>    
                    ${CANCEL_REASON_LIST.map(r => 
                        `<option value="${r.value}">${r.label}</option>`
                    ).join('')}
                </select>
                <button id="payment_cancel_clear_btn" type="button">í™•ì¸</button>
            `;

            $("#admin_payment_list_popup .inner_wrapper").html(html);
        });

        $(document).on('click', '#payment_cancel_clear_btn', function () {

            const reason = $("#payment_cancel_select").val();
            const orderId = $("#admin_payment_list_popup").data('order_id');

            if (!reason) {
                alert("ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            $.ajax({
                url: SPRING_BOOT_URL + "/zero9/orders/" + orderId + "/cancel",
                type: "PUT",
                contentType: "application/json",
                dataType: "json",
                headers: {
                    Authorization: ACCESS_TOKEN
                },
                data: JSON.stringify({
                    canceledReason: reason
                }),
                success: function (res) {
                    alert(res.message);

                    if(res.success){
                        $("#admin_payment_list_popup").remove();

                        // ğŸ”¥ í•µì‹¬: ë¦¬ìŠ¤íŠ¸ë§Œ ë‹¤ì‹œ ê°±ì‹ 
                        fetchPaymentList();
                    }
                },
                error: function (err) {
                    console.error("ê²°ì œ ì·¨ì†Œ ì—ëŸ¬:", err);
                    alert("ê²°ì œ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });

        /*
        const CANCEL_REASON_LIST = [
            'ë‹¨ìˆœ ë³€ì‹¬',
            'ê³ ê°ì— ì˜í•œ ê´€ë¦¬ì ì·¨ì†Œ'
        ];

        $.ajax({
            url: SPRING_BOOT_URL + "/zero9/admin/payments",
            method: "GET",
            dataType: "json",
            headers: {
                Authorization: ACCESS_TOKEN
            },
            success: function(res){
                const PAYMENT_LIST = res.data;

                console.log(PAYMENT_LIST)
                
                const PAYMENT_LIST_ELEMENT = $('#admin_payment_main .list');
                
                let LI_ELEMENT = '';

                if(PAYMENT_LIST.length != 0){
                   PAYMENT_LIST.forEach(item => {
                        let payment_cancel_element = '';

                        if(item.orderStatus === 'PAID'){
                            payment_cancel_element = `
                                <div class="btn_box">
                                    <button class="btn" type="button" data-order_id="${item.orderId}">ê²°ì œì·¨ì†Œ</button>
                                </div>
                            `;
                        }

                        LI_ELEMENT += `
                            <li>
                                <p class="nickname">${item.nickname}</p>

                                <div class="order_data">
                                    <p class="order_no">ì£¼ë¬¸ ë²ˆí˜¸: ${item.orderNo}</p>
                                    <p class="payment_no">ê²°ì œ ë²ˆí˜¸: ${item.paymentKey}</p>
                                </div>

                                <div class="option_data">
                                    <p class="option">${item.productOptionName}</p>
                                    <p class="total_amount">${item.totalAmount.toLocaleString()}</p>
                                </div>
                                
                                ${payment_cancel_element}

                                <span class="status">${item.orderStatus}</span>
                            </li>
                        `;

                        
                    });
                }else{

                }

                PAYMENT_LIST_ELEMENT.append(LI_ELEMENT);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("ê²°ì œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", textStatus, errorThrown);

                alert("ê²°ì œ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        });

        // íŒì—… ì—´ê¸°
        $(document).on("click", "#admin_payment_main .list .btn_box .btn", function () {

            popupLayer("admin_payment_list_popup");

            const THIS_ORDER_ID = $(this).data('order_id');
            $("#admin_payment_list_popup").data('order_id', THIS_ORDER_ID);

            const ELEMENT_LAYER = `
                <select id="payment_cancel_select">
                    <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>    
                </select>
                <button id="payment_cancel_clear_btn" type="button">í™•ì¸</button>
            `;

            $("#admin_payment_list_popup .inner_wrapper").html(ELEMENT_LAYER);

            let cancel_option = '';
            $.each(CANCEL_REASON_LIST, function (key, value) {
                cancel_option += `<option value="${key}">${value}</option>`;
            });

            $("#payment_cancel_select").append(cancel_option);
        });
        
        $(document).on('click', '#payment_cancel_clear_btn', function () {

            const reason_value = $("#payment_cancel_select").val();
            const orderId = $("#admin_payment_list_popup").data('order_id');

            if (!reason_value) {
                alert("ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

                return;
            }

            $.ajax({
                url: SPRING_BOOT_URL + "/zero9/orders/" + orderId + "/cancel",
                type: "PUT",
                contentType: "application/json",
                dataType: "json",
                headers: {
                    Authorization: ACCESS_TOKEN
                },
                data: JSON.stringify({
                    canceledReason: CANCEL_REASON_LIST[reason_value]
                }),
                success: function (res) {
                    alert(res.message);
                    
                    if(res.success){
                        $("#admin_payment_list_popup").remove();
                    }
                },
                error: function (xhr) {
                    console.error("ê²°ì œ ì·¨ì†Œ ì—ëŸ¬:", xhr);

                    alert("ê²°ì œ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });
        */
    </script>
</body>
</html>